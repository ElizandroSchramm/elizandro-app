<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="Web site created by Elizandro José Schramm"
    />
    <link href="styles/style.css" rel="stylesheet"></link>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@200;400;600&display=swap" rel="stylesheet">
    <script src="tokenwidget.js"></script>
    <title>Elizandro José Schramm</title>
  </head>
  <section id="main">
    <div class="signing-container">
      <div class="signing-header">
        <h1>Processo de Assinatura Digital</h1>
        <p class="subtitle">Siga os passos abaixo para assinar seu contrato de forma segura</p>
      </div>

      <div class="steps-container">
        <div class="step active" id="step1">
          <div class="step-number">1</div>
          <div class="step-content">
            <h2>Carregar Contrato</h2>
            <div id='setDiv'>
              <label>Chave de Assinatura</label>
              <input type="text" id="key" name="key" required="true" placeholder="Digite a chave de assinatura" />
              <input id="setButton" type="submit" class="submitSignature" value="Carregar Contrato" onclick="setWidget()" />
            </div>
            <a id="showDoc" href="" target="_blank" class="view-doc-button">Visualizar Documento</a>
          </div>
        </div>

        <div class="step" id="step2">
          <div class="step-number">2</div>
          <div class="step-content">
            <h2>Identificação</h2>
            <form id="form" action="success.html" onsubmit="return false">
              <div class="form-group">
                <label>CPF</label>
                <input type="text" id="cpf" name="cpf" placeholder="000.000.000-00" />
              </div>

              <div class="form-group">
                <label>Data de Nascimento</label>
                <input type="date" id="birthdate" name="birthdate" />
              </div>

              <div id="cs-tokenless-widget"></div>
              
              <input disabled='disabled' id="submitButton" type="submit" class="submitSignature" value="Assinar Documento" />
            </form>
          </div>
        </div>
      </div>
    </div>
  </section>
  <script>
    function setWidget(){
      const submitButton = document.getElementById('submitButton')
      const key = document.getElementById('key').value
      if (key === '') {
        alert('Chave de assinatura não pode ser vazia')
        return
      }

      const tw = new tokenlessWidget(key, "production", { domain: '.clicksign.com', show_files: false, pdf: false })
      tw.injectLoader('<div class="loader"></div>')

      tw.attach('click', 'submitButton', () => {
        const data = {
          "signature": {
            "birthday": document.getElementById("birthdate").value,
            "documentation": document.getElementById("cpf").value
          }
        }

        tw.sign(data)
        .then(() => {
          submitButton.setAttribute("value", "Assinatura realizada com sucesso!");
          submitButton.setAttribute("style", "background-color: green;");
          console.log('Assinatura realizada com sucesso!')
        })
        .catch((error) => {
          submitButton.setAttribute("value", `Erro ao assinar o documento. Confira log`);
          submitButton.setAttribute("style", "background-color: red;");
          console.log(error.code, error.message)
        })
      })

      tw.mount({
        'containerId':'cs-tokenless-widget',
        'textTemplate': 'creditas_5'
      })
      submitButton.removeAttribute('disabled')
    }
  </script>
  
</html>
